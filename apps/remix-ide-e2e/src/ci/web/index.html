<!doctype html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Select Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
      /* Leave space at bottom for sticky log panel */
      :root { --log-height: 28vh; }
  body { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; padding-bottom: calc(var(--log-height) + 1rem); background: var(--bs-body-bg); color: var(--bs-body-color); }
  .container-page { max-width: 1200px; margin: 1.25rem auto; }
      header { display: flex; gap: 1rem; align-items: center; }
      .row { display: flex; gap: 0.5rem; align-items: center; }
  input[type=text]{ padding: .4rem .6rem; width: 320px; }
  button { cursor: pointer; }
  table { width: 100%; border-collapse: collapse; margin-top: .5rem; }
  .badge { font-size: .8rem; padding: .1rem .35rem; border: 1px solid #ccc; border-radius: .35rem; }
      .ok { color: #0a0; }
      .warn { color: #b80; }
      .err { color: #a00; }

  /* Layout */
  .content { display: block; }
  #rightCol { display: none; }
  body.split-view .content { display: grid; grid-template-columns: var(--left-col, 1.1fr) 6px 1fr; gap: 1rem; align-items: start; }
  #colResizer { display: none; }
  body.split-view #colResizer { display: block; cursor: col-resize; background: #e5e5e5; border-radius: 3px; height: 100%; }
  body.split-view #colResizer:hover { background: #d0d0d0; }
  body.split-view #colResizer:active { background: #c0c0c0; }
  body.split-view #rightCol { display: block; }
  #ciPanel { max-height: calc(100vh - var(--log-height) - 2rem); overflow: auto; }
  body.log-collapsed #ciPanel { max-height: calc(100vh - 2rem); }
  /* Pinned CI details stays in view as you scroll */
  #ciPanel.pin { position: sticky; top: .5rem; align-self: start; }

      /* Sticky log panel */
      #log {
        position: fixed;
        left: 0; right: 0; bottom: 0;
        height: var(--log-height);
        margin: 0; padding: 0.75rem 1rem;
        background: var(--bs-body-bg);
        color: var(--bs-body-color);
        border-top: 1px solid var(--bs-border-color);
        overflow: auto;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        white-space: pre-wrap;
        z-index: 1000;
      }
  #log::before { content: 'Log'; display: block; color: #9aa0a6; font-size: 12px; letter-spacing: .06em; text-transform: uppercase; margin-bottom: .25rem; }

      /* Collapsed log state */
      body.log-collapsed { padding-bottom: 1rem; }
      body.log-collapsed #log { height: 0; padding: 0; border-top: 0; overflow: hidden; }
  /* Floating log button (visible when log collapsed) */
  #logFab { position: fixed; right: 12px; bottom: 12px; z-index: 1100; background: var(--bs-body-bg); color: var(--bs-body-color); border: 1px solid var(--bs-border-color); border-radius: 20px; padding: .45rem .8rem; box-shadow: 0 2px 8px rgba(0,0,0,.25); cursor: pointer; display: none; }
  #logFab:hover { filter: brightness(0.95); }
    </style>
  </head>
  <body data-bs-theme="light">
    <div class="container-page">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h4 class="m-0">Select & Run a Test</h4>
        <span id="status" class="badge text-bg-secondary">Loading…</span>
      </div>
      <div class="mb-2" id="progressRow" style="display:none;">
        <div class="progress" role="progressbar" aria-label="Pipeline progress" aria-valuemin="0" aria-valuemax="100">
          <div id="pipelineProgress" class="progress-bar" style="width: 0%">0%</div>
        </div>
        <div class="small text-muted mt-1" id="progressText"></div>
      </div>
      <ul class="nav nav-tabs mb-2" id="topTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <a class="nav-link active" href="#" data-tab="tests" role="tab" aria-selected="true">Tests</a>
        </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link" href="#" data-tab="ci" role="tab" aria-selected="false">CI</a>
        </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link" href="#" data-tab="log" role="tab" aria-selected="false">Log</a>
        </li>
      </ul>
      <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
        <div class="input-group" style="width: 340px;">
          <span class="input-group-text">Filter</span>
          <input id="filter" type="text" class="form-control" placeholder="type to filter by name"/>
        </div>
        <div class="input-group" style="width: 200px;">
          <span class="input-group-text">Mode</span>
          <select id="mode" class="form-select">
            <option value="local">Local</option>
            <option value="remote">CircleCI</option>
          </select>
        </div>
        <div class="input-group" style="width: 200px;">
          <span class="input-group-text">Browser</span>
          <select id="browser" class="form-select">
            <option value="chrome">chrome</option>
            <option value="firefox">firefox</option>
          </select>
        </div>
        <div class="input-group" style="width: 210px;">
          <span class="input-group-text">Layout</span>
          <select id="layout" class="form-select">
            <option value="inline">Inline</option>
            <option value="split">Split</option>
          </select>
        </div>
        <div class="form-check form-switch ms-2">
          <input class="form-check-input" type="checkbox" id="pinDetails">
          <label class="form-check-label" for="pinDetails">Pin details</label>
        </div>
        <div class="form-check form-switch ms-2">
          <input class="form-check-input" type="checkbox" id="darkMode">
          <label class="form-check-label" for="darkMode">Dark mode</label>
        </div>
        <div class="vr"></div>
        <button id="clearLog" class="btn btn-outline-secondary btn-sm">Clear log</button>
        <button id="logMinus" class="btn btn-outline-secondary btn-sm">Log -</button>
        <button id="logPlus" class="btn btn-outline-secondary btn-sm">Log +</button>
        <button id="toggleLog" class="btn btn-outline-secondary btn-sm">Hide log</button>
        <div class="vr"></div>
        <button id="setToken" class="btn btn-primary btn-sm">Set token</button>
      </div>
    <div id="content" class="content">
      <div id="leftCol">
        <div id="favoritesBlock" class="mb-2" style="display:none;">
          <div class="d-flex align-items-center justify-content-between">
            <h6 class="m-0">Favorites</h6>
            <button id="clearFavorites" class="btn btn-sm btn-outline-secondary">Clear</button>
          </div>
          <table class="table table-hover align-middle mt-1">
            <thead><tr><th>Name</th><th style="width:90px;">Built</th><th style="width:110px;"></th></tr></thead>
            <tbody id="favBody"></tbody>
          </table>
        </div>
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>Name</th>
              <th style="width:90px;">Built</th>
              <th style="width:110px;"></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="ciInlineAnchor"></div>
        <div id="actions" class="d-flex gap-2" style="margin-top:.5rem"></div>
      </div>
      <div id="colResizer" title="Drag to resize"></div>
      <div id="rightCol">
        <div id="ciPanel"><!-- ciDetails will be moved here in split view --></div>
      </div>
    </div>
  <div id="ciDetails" class="container-page" style="margin-top: 1rem"></div>
  <pre id="log"></pre>
  <button id="logFab" title="Show log">Log</button>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
      const $ = (s) => document.querySelector(s)
      const tbody = $('#tbody')
      const status = $('#status')
      const filter = $('#filter')
      const modeSel = $('#mode')
      const browserSel = $('#browser')
  const log = $('#log')
  const logFab = document.getElementById('logFab')
  const actions = $('#actions')
  const layoutSel = document.getElementById('layout')
  const pinChk = document.getElementById('pinDetails')
  const topTabs = document.getElementById('topTabs')
  const ciDetailsEl = document.getElementById('ciDetails')
  const ciInlineAnchor = document.getElementById('ciInlineAnchor')
  const ciPanel = document.getElementById('ciPanel')
  const progressRow = document.getElementById('progressRow')
  const progressBar = document.getElementById('pipelineProgress')
  const progressText = document.getElementById('progressText')
  const darkMode = document.getElementById('darkMode')
  const favoritesBlock = document.getElementById('favoritesBlock')
  const favBody = document.getElementById('favBody')
  let tests = []
  let lastStatus = null
  let scrolledCiOnce = false
  let drag = { active: false, startX: 0, startLeft: 0 }
  let favorites = new Set()

      async function fetchStatus() {
        const r = await fetch('/api/status')
        const j = await r.json()
        const t = []
        t.push('branch: ' + j.branch)
        t.push('circle token: ' + (j.hasToken ? '✅' : '⚠️ missing'))
        status.textContent = t.join(' · ')
        status.className = 'badge ' + (j.hasToken ? 'ok' : 'warn')
      }

      function render() {
        const q = filter.value.toLowerCase()
        const rows = tests.filter(x => x.base.toLowerCase().includes(q)).map((t) => `
          <tr>
            <td><button class="btn btn-link p-0 me-1 star" data-star="${t.base}" title="Toggle favorite">${favorites.has(t.base) ? '★' : '☆'}</button><code>${t.base}</code></td>
            <td>${t.hasDist ? '<span class="badge text-bg-success">built</span>' : '<span class="badge text-bg-warning">missing</span>'}</td>
            <td><button class="btn btn-sm btn-outline-primary" data-test="${t.base}">Run</button></td>
          </tr>
        `)
        tbody.innerHTML = rows.join('')
        tbody.querySelectorAll('button[data-test]').forEach(btn => btn.onclick = (ev) => trigger(ev.target.dataset.test))
        tbody.querySelectorAll('button.star').forEach(btn => btn.onclick = (ev) => toggleFavorite(ev.target.getAttribute('data-star')))
      }

      function renderFavorites() {
        const q = filter.value.toLowerCase()
        const favTests = tests.filter(t => favorites.has(t.base) && t.base.toLowerCase().includes(q))
        favoritesBlock.style.display = favTests.length ? '' : 'none'
        const rows = favTests.map((t) => `
          <tr>
            <td><button class="btn btn-link p-0 me-1 star" data-star="${t.base}" title="Toggle favorite">${favorites.has(t.base) ? '★' : '☆'}</button><code>${t.base}</code></td>
            <td>${t.hasDist ? '<span class="badge text-bg-success">built</span>' : '<span class="badge text-bg-warning">missing</span>'}</td>
            <td><button class="btn btn-sm btn-outline-primary" data-test="${t.base}">Run</button></td>
          </tr>
        `)
        favBody.innerHTML = rows.join('')
        favBody.querySelectorAll('button[data-test]').forEach(btn => btn.onclick = (ev) => trigger(ev.target.dataset.test))
        favBody.querySelectorAll('button.star').forEach(btn => btn.onclick = (ev) => toggleFavorite(ev.target.getAttribute('data-star')))
      }

      document.getElementById('clearFavorites').onclick = () => { favorites = new Set(); try { localStorage.setItem('selectTestFavorites','[]') } catch (_) {}; renderFavorites(); render() }

      function toggleFavorite(name) {
        if (favorites.has(name)) favorites.delete(name); else favorites.add(name)
        try { localStorage.setItem('selectTestFavorites', JSON.stringify(Array.from(favorites))) } catch (_) {}
        renderFavorites(); render()
      }

      async function load() {
        // Restore settings
        try {
          const s = JSON.parse(localStorage.getItem('selectTestSettings') || '{}')
          if (s.filter) filter.value = s.filter
          if (s.mode) modeSel.value = s.mode
          if (s.browser) browserSel.value = s.browser
          if (s.layout) layoutSel.value = s.layout
          if (s.pinDetails) pinChk.checked = true
          if (s.darkMode) { darkMode.checked = true; document.body.setAttribute('data-bs-theme','dark') }
          if (s.logCollapsed) document.body.classList.add('log-collapsed')
        } catch (_) {}
        try {
          const fav = JSON.parse(localStorage.getItem('selectTestFavorites') || '[]')
          favorites = new Set(Array.isArray(fav) ? fav : [])
        } catch (_) {}
        await fetchStatus()
        const r = await fetch('/api/tests')
        const j = await r.json()
        tests = j.tests || []
  render()
  renderFavorites()
  updateToggleLogText()
        applyLayout()
        restoreSplitWidth()
  updateLogFab()
    setActiveTab('tests')
      }

      function persistSettings() {
        try {
          localStorage.setItem('selectTestSettings', JSON.stringify({
            filter: filter.value,
            mode: modeSel.value,
            browser: browserSel.value,
            layout: layoutSel.value,
            pinDetails: pinChk.checked
          }))
        } catch (_) {}
      }

      async function trigger(name) {
        const mode = modeSel.value
        const browser = browserSel.value
        // Append instead of overwrite so we keep history
        const start = `\n> triggering ${name} (${mode})...\n`
        log.textContent += start
        log.scrollTop = log.scrollHeight
        const r = await fetch('/api/trigger', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mode, test: name, browser }) })
        const j = await r.json()
        log.textContent += JSON.stringify(j, null, 2) + "\n"
        log.scrollTop = log.scrollHeight
        if (j.url) {
          const a = document.createElement('a')
          a.href = j.url
          a.textContent = 'open pipeline'
          a.target = '_blank'
          log.appendChild(document.createElement('br'))
          log.appendChild(a)
          log.appendChild(document.createElement('br'))
          log.scrollTop = log.scrollHeight
        }

        // If remote, start polling for CI status
        if (mode === 'remote' && j.pipelineId) {
          await pollCi(j.pipelineId)
        }
      }

      async function pollCi(pipelineId) {
        const pad = (s) => (s || 'unknown').toString().padEnd(10, ' ')
        const sleep = (ms) => new Promise(r => setTimeout(r, ms))
        log.textContent += `pipeline: ${pipelineId} -> fetching status...\n`
        log.scrollTop = log.scrollHeight
        let done = false
        while (!done) {
          try {
            const r = await fetch(`/api/ci-status?pipelineId=${encodeURIComponent(pipelineId)}`)
            const j = await r.json()
            if (!r.ok) throw new Error(j && j.details || 'status error')
            lastStatus = j
            renderActions()
            renderCiDetails()
            renderProgress()
            const wfLines = (j.workflows || []).map(wf => `  - ${wf.name}  ${pad(wf.status)}  (id ${wf.id})`).join('\n')
            const counts = j.summary && j.summary.counts ? JSON.stringify(j.summary.counts) : '{}'
            const ui = j.uiUrl ? `\n  ${j.uiUrl}\n` : '\n'
            log.textContent += `status: pipeline ${j.pipeline.number || ''} state=${j.pipeline.state} workflows=${counts}${ui}${wfLines}\n`
            log.scrollTop = log.scrollHeight
            done = Boolean(j.summary && j.summary.done)
            if (!done) await sleep(5000)
          } catch (e) {
            log.textContent += `status error: ${e.message}\n`
            log.scrollTop = log.scrollHeight
            await sleep(7000)
          }
        }
        log.textContent += `pipeline complete.\n`
        log.scrollTop = log.scrollHeight
      }

      function renderCiDetails() {
        const el = document.getElementById('ciDetails')
        if (!lastStatus) { el.innerHTML = ''; return }
        const wfHtml = (lastStatus.workflows || []).map(wf => {
          const jobs = (lastStatus.jobsByWf && lastStatus.jobsByWf[wf.id]) || []
          const rows = jobs.map(j => {
            const dur = j.durationSec != null ? `${j.durationSec}s` : ''
            const link = j.ui ? `<a href="${j.ui}" target="_blank">open</a>` : ''
            const artifactsBtn = (lastStatus.pipeline && lastStatus.pipeline.project_slug && j.job_number)
              ? `<button class="btn btn-sm btn-outline-secondary" data-artifacts='{"project":"${lastStatus.pipeline.project_slug}","job":${j.job_number}}'>Artifacts</button>`
              : ''
            const copyBtn = (String(j.status).toLowerCase()==='failed' && lastStatus.pipeline && lastStatus.pipeline.parameters && lastStatus.pipeline.parameters.run_file_tests)
              ? `<button class="btn btn-sm btn-outline-danger" data-copytest="${(lastStatus.pipeline.parameters.run_file_tests||'').replace(/"/g,'&quot;')}">Copy test</button>`
              : ''
            const statusBadge = (s => {
              s = (s||'').toLowerCase();
              if (s==='success') return '<span class="badge text-bg-success">success</span>'
              if (s==='failed' || s==='error') return '<span class="badge text-bg-danger">failed</span>'
              if (s==='running' || s==='on_hold') return '<span class="badge text-bg-info">'+s+'</span>'
              if (s==='canceled') return '<span class="badge text-bg-secondary">canceled</span>'
              return '<span class="badge text-bg-light text-dark">'+(s||'unknown')+'</span>'
            })(j.status)
            return `<tr>
              <td>${j.name || j.job_number || ''}</td>
              <td>${statusBadge}</td>
              <td>${dur}</td>
              <td class="d-flex gap-1">${link} ${artifactsBtn} ${copyBtn}</td>
            </tr>
            <tr class="artifacts-row" data-for="${j.job_number}" style="display:none"><td colspan="4"><div class="small text-muted">Loading artifacts…</div></td></tr>`
          }).join('')
          const table = rows ? `<table class="table table-sm mb-0"><thead><tr><th class="text-start">Job</th><th>Status</th><th>Duration</th><th></th></tr></thead><tbody>${rows}</tbody></table>` : '<div class="text-muted">No jobs</div>'
          const wfBadge = (s => {
            s = (s||'').toLowerCase();
            if (s==='success') return '<span class="badge text-bg-success">success</span>'
            if (s==='failed' || s==='error') return '<span class="badge text-bg-danger">failed</span>'
            if (s==='running' || s==='on_hold') return '<span class="badge text-bg-info">'+s+'</span>'
            if (s==='canceled') return '<span class="badge text-bg-secondary">canceled</span>'
            return '<span class="badge text-bg-light text-dark">'+(s||'unknown')+'</span>'
          })(wf.status)
          return `<div class="card mb-2"><div class="card-header d-flex justify-content-between align-items-center"><div><strong>${wf.name}</strong></div><div>${wfBadge}</div></div><div class="card-body">${table}</div></div>`
        }).join('')
        const copyTop = (lastStatus && lastStatus.pipeline && lastStatus.pipeline.parameters && lastStatus.pipeline.parameters.run_file_tests)
          ? `<button id="copyParamTest" class="btn btn-sm btn-outline-secondary mb-2">Copy test param</button>` : ''
        el.innerHTML = `<h4>CI details</h4>${copyTop}${wfHtml}`
        // Wire artifacts and copy buttons
        el.querySelectorAll('button[data-artifacts]').forEach(btn => btn.onclick = async (ev) => {
          const data = JSON.parse(ev.currentTarget.getAttribute('data-artifacts'))
          const table = ev.currentTarget.closest('table')
          if (!table) return
          const row = table.querySelector(`tr.artifacts-row[data-for="${data.job}"]`)
          if (!row) return
          row.style.display = ''
          row.querySelector('td').innerHTML = '<div class="small text-muted">Loading artifacts…</div>'
          try {
            const r = await fetch(`/api/ci-artifacts?projectSlug=${encodeURIComponent(data.project)}&jobNumber=${encodeURIComponent(data.job)}`)
            const j = await r.json()
            if (!r.ok) throw new Error(j && j.details || 'artifacts error')
            const items = (j.items||[])
            if (!items.length) { row.querySelector('td').innerHTML = '<span class="text-muted">No artifacts</span>'; return }
            const list = items.map(it => {
              const p = it.path || ''
              const label = /\.png$/i.test(p) ? 'screenshot' : (/(mp4|webm)$/i.test(p) ? 'video' : 'artifact')
              return `<li><a href="${it.url}" target="_blank">${label}</a> <span class="text-muted">${p}</span></li>`
            }).join('')
            row.querySelector('td').innerHTML = `<ul class="mb-0">${list}</ul>`
          } catch (e) {
            row.querySelector('td').innerHTML = `<span class="text-danger">${e.message}</span>`
          }
        })
        const copyParam = el.querySelector('#copyParamTest')
        if (copyParam && lastStatus.pipeline && lastStatus.pipeline.parameters && lastStatus.pipeline.parameters.run_file_tests) {
          copyParam.onclick = () => copyText(lastStatus.pipeline.parameters.run_file_tests)
        }
        el.querySelectorAll('button[data-copytest]').forEach(btn => btn.onclick = (ev) => copyText(ev.currentTarget.getAttribute('data-copytest')))
        if (!scrolledCiOnce && layoutSel.value === 'inline') {
          el.scrollIntoView({ behavior: 'smooth', block: 'start' })
          scrolledCiOnce = true
        }
      }
      function renderProgress() {
        try {
          const wfs = (lastStatus && lastStatus.workflows) || []
          const jobsByWf = (lastStatus && lastStatus.jobsByWf) || {}
          let total = 0, done = 0
          const term = new Set(['success','failed','canceled','error'])
          for (const wf of wfs) {
            const jobs = jobsByWf[wf.id] || []
            total += jobs.length
            done += jobs.filter(j => term.has(String(j.status||'').toLowerCase())).length
          }
          if (total === 0) { progressRow.style.display = 'none'; return }
          const pct = Math.round((done/total)*100)
          progressRow.style.display = ''
          progressBar.style.width = pct + '%'
          progressBar.textContent = pct + '%'
          progressBar.className = 'progress-bar ' + (pct===100 ? 'bg-success' : '')
          progressText.textContent = `${done} of ${total} jobs completed`
        } catch (_) { /* ignore */ }
      }

      filter.oninput = () => { render(); renderFavorites(); persistSettings() }

      function renderActions() {
        actions.innerHTML = ''
        if (!lastStatus) return
        // Find a running workflow to offer Cancel
        const running = (lastStatus.workflows || []).find(wf => String(wf.status).toLowerCase() === 'running')
        // Find a failed workflow to offer Rerun
        const failed = (lastStatus.workflows || []).find(wf => String(wf.status).toLowerCase() === 'failed')
        const buttons = []
        if (running) {
          const b = document.createElement('button')
          b.textContent = `Cancel ${running.name}`
          b.onclick = () => ciCancel(running.id)
          buttons.push(b)
        }
        if (failed) {
          const b1 = document.createElement('button')
          b1.textContent = `Rerun failed: ${failed.name}`
          b1.onclick = () => ciRerun(failed.id, true)
          const b2 = document.createElement('button')
          b2.textContent = `Rerun all: ${failed.name}`
          b2.onclick = () => ciRerun(failed.id, false)
          buttons.push(b1, b2)
        }
        buttons.forEach(btn => actions.appendChild(btn))
      }

      async function ciCancel(workflowId) {
        const r = await fetch('/api/ci/cancel', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ workflowId }) })
        const j = await r.json()
        log.textContent += `cancel: ${JSON.stringify(j)}\n`
        log.scrollTop = log.scrollHeight
      }

      async function ciRerun(workflowId, from_failed) {
        const r = await fetch('/api/ci/rerun', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ workflowId, from_failed }) })
        const j = await r.json()
        log.textContent += `rerun: ${JSON.stringify(j)}\n`
        log.scrollTop = log.scrollHeight
      }

  filter.oninput = () => { render(); renderFavorites(); persistSettings() }
  modeSel.onchange = persistSettings
  browserSel.onchange = persistSettings
  layoutSel.onchange = () => { applyLayout(); persistSettings() }
  pinChk.onchange = () => { applyLayout(); persistSettings() }
  darkMode.onchange = () => {
    document.body.setAttribute('data-bs-theme', darkMode.checked ? 'dark' : 'light')
    try {
      const s = JSON.parse(localStorage.getItem('selectTestSettings') || '{}')
      s.darkMode = darkMode.checked
      localStorage.setItem('selectTestSettings', JSON.stringify(s))
    } catch (_) {}
  }
      // UI helpers
      $('#clearLog').onclick = () => { log.textContent = '' }
      $('#logMinus').onclick = () => adjustLog(-5)
      $('#logPlus').onclick = () => adjustLog(5)
      $('#setToken').onclick = async () => {
        const token = prompt('CircleCI token')
        if (!token) return
        const r = await fetch('/api/set-token', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token }) })
        const j = await r.json()
        log.textContent += `set-token: ${JSON.stringify(j)}\n`
        fetchStatus()
      }

      function adjustLog(delta) {
        const root = document.documentElement
        const cur = parseInt(getComputedStyle(root).getPropertyValue('--log-height'))
        const next = Math.max(15, Math.min(80, cur + delta))
        root.style.setProperty('--log-height', next + 'vh')
      }

      function toggleLogUI() {
        document.body.classList.toggle('log-collapsed')
        persistLogCollapsed()
        updateToggleLogText()
        updateLogFab()
      }
      document.getElementById('toggleLog').onclick = toggleLogUI
      logFab.onclick = toggleLogUI

      function persistLogCollapsed() {
        try {
          const s = JSON.parse(localStorage.getItem('selectTestSettings') || '{}')
          s.logCollapsed = document.body.classList.contains('log-collapsed')
          localStorage.setItem('selectTestSettings', JSON.stringify(s))
        } catch (_) {}
      }

      function updateToggleLogText() {
        const btn = document.getElementById('toggleLog')
        const collapsed = document.body.classList.contains('log-collapsed')
        btn.textContent = collapsed ? 'Show log' : 'Hide log'
      }

      function updateLogFab() {
        const collapsed = document.body.classList.contains('log-collapsed')
        logFab.style.display = collapsed ? 'inline-block' : 'none'
      }

      // Tabs handling: Tests, CI, Log
      function setActiveTab(name) {
        // nav classes
        Array.from(topTabs.querySelectorAll('a.nav-link')).forEach(a => {
          const isActive = a.dataset.tab === name
          a.classList.toggle('active', isActive)
          a.setAttribute('aria-selected', String(isActive))
        })
        // Show/hide sections
        const content = document.getElementById('content')
        const ci = document.getElementById('ciDetails')
        if (name === 'tests') {
          content.style.display = ''
          ci.style.display = ''
        } else if (name === 'ci') {
          // Ensure inline layout so details are visible
          if (layoutSel.value !== 'inline') { layoutSel.value = 'inline'; applyLayout(); persistSettings() }
          content.style.display = 'none'
          ci.style.display = ''
          ci.scrollIntoView({ behavior: 'smooth', block: 'start' })
        } else if (name === 'log') {
          content.style.display = 'none'
          ci.style.display = 'none'
          // Show log panel and scroll bottom
          if (document.body.classList.contains('log-collapsed')) toggleLogUI()
          setTimeout(() => { log.scrollTop = log.scrollHeight }, 50)
        }
      }

      topTabs.addEventListener('click', (e) => {
        const a = e.target.closest('a[data-tab]')
        if (!a) return
        e.preventDefault()
        setActiveTab(a.dataset.tab)
      })

      function copyText(t) {
        try { navigator.clipboard.writeText(t) } catch (_) {
          const ta = document.createElement('textarea'); ta.value = t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta)
        }
      }

      function applyLayout() {
        const isSplit = layoutSel.value === 'split'
        document.body.classList.toggle('split-view', isSplit)
        // Move CI details element to right panel in split view, otherwise inline
        if (isSplit) {
          if (ciDetailsEl.parentElement !== ciPanel) ciPanel.appendChild(ciDetailsEl)
          ciPanel.classList.toggle('pin', pinChk.checked)
          bindResizer()
        } else {
          if (ciDetailsEl.parentElement !== ciInlineAnchor.parentElement) ciInlineAnchor.insertAdjacentElement('afterend', ciDetailsEl)
        }
      }

      function bindResizer() {
        const handle = document.getElementById('colResizer')
        if (!handle) return
        handle.onmousedown = (e) => {
          drag.active = true
          drag.startX = e.clientX
          drag.startLeft = getLeftWidthPx()
          document.body.style.userSelect = 'none'
        }
        window.onmousemove = (e) => {
          if (!drag.active) return
          const dx = e.clientX - drag.startX
          const next = Math.max(280, drag.startLeft + dx)
          setLeftWidthPx(next)
        }
        window.onmouseup = () => {
          if (!drag.active) return
          drag.active = false
          document.body.style.userSelect = ''
          persistSplitWidth()
        }
      }

      function getLeftWidthPx() {
        // Compute current left column width in pixels
        const left = document.getElementById('leftCol')
        const rect = left.getBoundingClientRect()
        return Math.round(rect.width)
      }

      function setLeftWidthPx(px) {
        document.documentElement.style.setProperty('--left-col', px + 'px')
      }

      function persistSplitWidth() {
        try {
          const s = JSON.parse(localStorage.getItem('selectTestSettings') || '{}')
          s.leftWidthPx = getLeftWidthPx()
          localStorage.setItem('selectTestSettings', JSON.stringify(s))
        } catch (_) {}
      }

      function restoreSplitWidth() {
        try {
          const s = JSON.parse(localStorage.getItem('selectTestSettings') || '{}')
          if (s.leftWidthPx) setLeftWidthPx(s.leftWidthPx)
        } catch (_) {}
      }
      load()
    </script>
  </body>
  </html>
