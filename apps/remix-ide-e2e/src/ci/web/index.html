<!doctype html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Select Test</title>
    <style>
      /* Leave space at bottom for sticky log panel */
      :root { --log-height: 28vh; }
      body { font-family: ui-sans-serif, system-ui, sans-serif; margin: 1.5rem; padding-bottom: calc(var(--log-height) + 1rem); }
      header { display: flex; gap: 1rem; align-items: center; }
      .row { display: flex; gap: 0.5rem; align-items: center; }
      input[type=text]{ padding: .4rem .6rem; width: 320px; }
      button { padding: .4rem .7rem; cursor: pointer; }
      table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
      th, td { border-bottom: 1px solid #ddd; padding: .4rem .6rem; text-align: left; }
      tr:hover { background: #fafafa; }
  .badge { font-size: .8rem; padding: .1rem .35rem; border: 1px solid #ccc; border-radius: .35rem; }
      .ok { color: #0a0; }
      .warn { color: #b80; }
      .err { color: #a00; }

  /* Layout */
  .content { display: block; }
  #rightCol { display: none; }
  body.split-view .content { display: grid; grid-template-columns: var(--left-col, 1.1fr) 6px 1fr; gap: 1rem; align-items: start; }
  #colResizer { display: none; }
  body.split-view #colResizer { display: block; cursor: col-resize; background: #e5e5e5; border-radius: 3px; height: 100%; }
  body.split-view #colResizer:hover { background: #d0d0d0; }
  body.split-view #colResizer:active { background: #c0c0c0; }
  body.split-view #rightCol { display: block; }
  #ciPanel { max-height: calc(100vh - var(--log-height) - 2rem); overflow: auto; }
  body.log-collapsed #ciPanel { max-height: calc(100vh - 2rem); }
  /* Pinned CI details stays in view as you scroll */
  #ciPanel.pin { position: sticky; top: .5rem; align-self: start; }

      /* Sticky log panel */
      #log {
        position: fixed;
        left: 0; right: 0; bottom: 0;
        height: var(--log-height);
        margin: 0; padding: 0.75rem 1rem;
        background: #101010; color: #e8e8e8;
        border-top: 1px solid #333;
        overflow: auto;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        white-space: pre-wrap;
        z-index: 1000;
      }
      #log::before { content: 'Log'; display: block; color: #9aa0a6; font-size: 12px; letter-spacing: .06em; text-transform: uppercase; margin-bottom: .25rem; }

      /* Collapsed log state */
      body.log-collapsed { padding-bottom: 1rem; }
      body.log-collapsed #log { height: 0; padding: 0; border-top: 0; overflow: hidden; }
    </style>
  </head>
  <body>
    <header>
      <h2>Select & Run a Test</h2>
      <span id="status" class="badge">Loading…</span>
    </header>
    <div class="row">
      <label>Filter:</label>
      <input id="filter" type="text" placeholder="type to filter by name"/>
      <label>Mode:</label>
      <select id="mode">
        <option value="local">Local</option>
        <option value="remote">CircleCI</option>
      </select>
      <label>Browser:</label>
      <select id="browser">
        <option value="chrome">chrome</option>
        <option value="firefox">firefox</option>
      </select>
      <label>Layout:</label>
      <select id="layout">
        <option value="inline">Inline</option>
        <option value="split">Split</option>
      </select>
      <label style="gap:.25rem;display:flex;align-items:center"><input type="checkbox" id="pinDetails"/> Pin details</label>
      <button id="clearLog">Clear log</button>
      <button id="logMinus">Log -</button>
      <button id="logPlus">Log +</button>
      <button id="setToken">Set token</button>
      <button id="toggleLog">Hide log</button>
    </div>
    <div id="content" class="content">
      <div id="leftCol">
        <table>
          <thead>
            <tr>
              <th>Test</th>
              <th>Source</th>
              <th>Dist</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="ciInlineAnchor"></div>
        <div id="actions" class="row" style="margin-top:.5rem"></div>
      </div>
      <div id="colResizer" title="Drag to resize"></div>
      <div id="rightCol">
        <div id="ciPanel"><!-- ciDetails will be moved here in split view --></div>
      </div>
    </div>
    <div id="ciDetails" style="margin-top: 1rem"></div>

    <script>
      const $ = (s) => document.querySelector(s)
      const tbody = $('#tbody')
      const status = $('#status')
      const filter = $('#filter')
      const modeSel = $('#mode')
      const browserSel = $('#browser')
  const log = $('#log')
  const actions = $('#actions')
  const layoutSel = document.getElementById('layout')
  const pinChk = document.getElementById('pinDetails')
  const ciDetailsEl = document.getElementById('ciDetails')
  const ciInlineAnchor = document.getElementById('ciInlineAnchor')
  const ciPanel = document.getElementById('ciPanel')
  let tests = []
  let lastStatus = null
  let scrolledCiOnce = false
  let drag = { active: false, startX: 0, startLeft: 0 }

      async function fetchStatus() {
        const r = await fetch('/api/status')
        const j = await r.json()
        const t = []
        t.push('branch: ' + j.branch)
        t.push('circle token: ' + (j.hasToken ? '✅' : '⚠️ missing'))
        status.textContent = t.join(' · ')
        status.className = 'badge ' + (j.hasToken ? 'ok' : 'warn')
      }

      function render() {
        const q = filter.value.toLowerCase()
        const rows = tests.filter(x => x.base.toLowerCase().includes(q)).map((t) => `
          <tr>
            <td><code>${t.base}</code></td>
            <td>${t.src.replace('apps/remix-ide-e2e/src/tests/','')}</td>
            <td>${t.hasDist ? '<span class="ok">built</span>' : '<span class="warn">missing</span>'}</td>
            <td><button data-test="${t.base}">Run</button></td>
          </tr>
        `)
        tbody.innerHTML = rows.join('')
        tbody.querySelectorAll('button[data-test]').forEach(btn => btn.onclick = (ev) => trigger(ev.target.dataset.test))
      }

      async function load() {
        // Restore settings
        try {
          const s = JSON.parse(localStorage.getItem('selectTestSettings') || '{}')
          if (s.filter) filter.value = s.filter
          if (s.mode) modeSel.value = s.mode
          if (s.browser) browserSel.value = s.browser
          if (s.layout) layoutSel.value = s.layout
          if (s.pinDetails) pinChk.checked = true
          if (s.logCollapsed) document.body.classList.add('log-collapsed')
        } catch (_) {}
        await fetchStatus()
        const r = await fetch('/api/tests')
        const j = await r.json()
        tests = j.tests || []
        render()
        updateToggleLogText()
        applyLayout()
        restoreSplitWidth()
      }

      function persistSettings() {
        try {
          localStorage.setItem('selectTestSettings', JSON.stringify({
            filter: filter.value,
            mode: modeSel.value,
            browser: browserSel.value,
            layout: layoutSel.value,
            pinDetails: pinChk.checked
          }))
        } catch (_) {}
      }

      async function trigger(name) {
        const mode = modeSel.value
        const browser = browserSel.value
        // Append instead of overwrite so we keep history
        const start = `\n> triggering ${name} (${mode})...\n`
        log.textContent += start
        log.scrollTop = log.scrollHeight
        const r = await fetch('/api/trigger', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mode, test: name, browser }) })
        const j = await r.json()
        log.textContent += JSON.stringify(j, null, 2) + "\n"
        log.scrollTop = log.scrollHeight
        if (j.url) {
          const a = document.createElement('a')
          a.href = j.url
          a.textContent = 'open pipeline'
          a.target = '_blank'
          log.appendChild(document.createElement('br'))
          log.appendChild(a)
          log.appendChild(document.createElement('br'))
          log.scrollTop = log.scrollHeight
        }

        // If remote, start polling for CI status
        if (mode === 'remote' && j.pipelineId) {
          await pollCi(j.pipelineId)
        }
      }

      async function pollCi(pipelineId) {
        const pad = (s) => (s || 'unknown').toString().padEnd(10, ' ')
        const sleep = (ms) => new Promise(r => setTimeout(r, ms))
        log.textContent += `pipeline: ${pipelineId} -> fetching status...\n`
        log.scrollTop = log.scrollHeight
        let done = false
        while (!done) {
          try {
            const r = await fetch(`/api/ci-status?pipelineId=${encodeURIComponent(pipelineId)}`)
            const j = await r.json()
            if (!r.ok) throw new Error(j && j.details || 'status error')
            lastStatus = j
            renderActions()
            renderCiDetails()
            const wfLines = (j.workflows || []).map(wf => `  - ${wf.name}  ${pad(wf.status)}  (id ${wf.id})`).join('\n')
            const counts = j.summary && j.summary.counts ? JSON.stringify(j.summary.counts) : '{}'
            const ui = j.uiUrl ? `\n  ${j.uiUrl}\n` : '\n'
            log.textContent += `status: pipeline ${j.pipeline.number || ''} state=${j.pipeline.state} workflows=${counts}${ui}${wfLines}\n`
            log.scrollTop = log.scrollHeight
            done = Boolean(j.summary && j.summary.done)
            if (!done) await sleep(5000)
          } catch (e) {
            log.textContent += `status error: ${e.message}\n`
            log.scrollTop = log.scrollHeight
            await sleep(7000)
          }
        }
        log.textContent += `pipeline complete.\n`
        log.scrollTop = log.scrollHeight
      }

      function renderCiDetails() {
        const el = document.getElementById('ciDetails')
        if (!lastStatus) { el.innerHTML = ''; return }
        const wfHtml = (lastStatus.workflows || []).map(wf => {
          const jobs = (lastStatus.jobsByWf && lastStatus.jobsByWf[wf.id]) || []
          const rows = jobs.map(j => {
            const dur = j.durationSec != null ? `${j.durationSec}s` : ''
            const link = j.ui ? `<a href="${j.ui}" target="_blank">open</a>` : ''
            return `<tr><td>${j.name || j.job_number || ''}</td><td>${(j.status || 'unknown')}</td><td>${dur}</td><td>${link}</td></tr>`
          }).join('')
          const table = rows ? `<table style="width:100%;border-collapse:collapse;margin:.25rem 0"><thead><tr><th style="text-align:left">Job</th><th>Status</th><th>Duration</th><th></th></tr></thead><tbody>${rows}</tbody></table>` : '<div style="color:#777">No jobs</div>'
          return `<div style="border:1px solid #eee;padding:.5rem;margin-bottom:.5rem"><div><strong>${wf.name}</strong> — ${wf.status}</div>${table}</div>`
        }).join('')
        el.innerHTML = `<h4>CI details</h4>${wfHtml}`
        if (!scrolledCiOnce && layoutSel.value === 'inline') {
          el.scrollIntoView({ behavior: 'smooth', block: 'start' })
          scrolledCiOnce = true
        }
      }

      function renderActions() {
        actions.innerHTML = ''
        if (!lastStatus) return
        // Find a running workflow to offer Cancel
        const running = (lastStatus.workflows || []).find(wf => String(wf.status).toLowerCase() === 'running')
        // Find a failed workflow to offer Rerun
        const failed = (lastStatus.workflows || []).find(wf => String(wf.status).toLowerCase() === 'failed')
        const buttons = []
        if (running) {
          const b = document.createElement('button')
          b.textContent = `Cancel ${running.name}`
          b.onclick = () => ciCancel(running.id)
          buttons.push(b)
        }
        if (failed) {
          const b1 = document.createElement('button')
          b1.textContent = `Rerun failed: ${failed.name}`
          b1.onclick = () => ciRerun(failed.id, true)
          const b2 = document.createElement('button')
          b2.textContent = `Rerun all: ${failed.name}`
          b2.onclick = () => ciRerun(failed.id, false)
          buttons.push(b1, b2)
        }
        buttons.forEach(btn => actions.appendChild(btn))
      }

      async function ciCancel(workflowId) {
        const r = await fetch('/api/ci/cancel', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ workflowId }) })
        const j = await r.json()
        log.textContent += `cancel: ${JSON.stringify(j)}\n`
        log.scrollTop = log.scrollHeight
      }

      async function ciRerun(workflowId, from_failed) {
        const r = await fetch('/api/ci/rerun', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ workflowId, from_failed }) })
        const j = await r.json()
        log.textContent += `rerun: ${JSON.stringify(j)}\n`
        log.scrollTop = log.scrollHeight
      }

      filter.oninput = () => { render(); persistSettings() }
  modeSel.onchange = persistSettings
  browserSel.onchange = persistSettings
  layoutSel.onchange = () => { applyLayout(); persistSettings() }
  pinChk.onchange = () => { applyLayout(); persistSettings() }
      // UI helpers
      $('#clearLog').onclick = () => { log.textContent = '' }
      $('#logMinus').onclick = () => adjustLog(-5)
      $('#logPlus').onclick = () => adjustLog(5)
      $('#setToken').onclick = async () => {
        const token = prompt('CircleCI token')
        if (!token) return
        const r = await fetch('/api/set-token', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token }) })
        const j = await r.json()
        log.textContent += `set-token: ${JSON.stringify(j)}\n`
        fetchStatus()
      }

      function adjustLog(delta) {
        const root = document.documentElement
        const cur = parseInt(getComputedStyle(root).getPropertyValue('--log-height'))
        const next = Math.max(15, Math.min(80, cur + delta))
        root.style.setProperty('--log-height', next + 'vh')
      }

      $('#toggleLog').onclick = () => {
        document.body.classList.toggle('log-collapsed')
        persistLogCollapsed()
        updateToggleLogText()
      }

      function persistLogCollapsed() {
        try {
          const s = JSON.parse(localStorage.getItem('selectTestSettings') || '{}')
          s.logCollapsed = document.body.classList.contains('log-collapsed')
          localStorage.setItem('selectTestSettings', JSON.stringify(s))
        } catch (_) {}
      }

      function updateToggleLogText() {
        const btn = document.getElementById('toggleLog')
        const collapsed = document.body.classList.contains('log-collapsed')
        btn.textContent = collapsed ? 'Show log' : 'Hide log'
      }

      function applyLayout() {
        const isSplit = layoutSel.value === 'split'
        document.body.classList.toggle('split-view', isSplit)
        // Move CI details element to right panel in split view, otherwise inline
        if (isSplit) {
          if (ciDetailsEl.parentElement !== ciPanel) ciPanel.appendChild(ciDetailsEl)
          ciPanel.classList.toggle('pin', pinChk.checked)
          bindResizer()
        } else {
          if (ciDetailsEl.parentElement !== ciInlineAnchor.parentElement) ciInlineAnchor.insertAdjacentElement('afterend', ciDetailsEl)
        }
      }

      function bindResizer() {
        const handle = document.getElementById('colResizer')
        if (!handle) return
        handle.onmousedown = (e) => {
          drag.active = true
          drag.startX = e.clientX
          drag.startLeft = getLeftWidthPx()
          document.body.style.userSelect = 'none'
        }
        window.onmousemove = (e) => {
          if (!drag.active) return
          const dx = e.clientX - drag.startX
          const next = Math.max(280, drag.startLeft + dx)
          setLeftWidthPx(next)
        }
        window.onmouseup = () => {
          if (!drag.active) return
          drag.active = false
          document.body.style.userSelect = ''
          persistSplitWidth()
        }
      }

      function getLeftWidthPx() {
        // Compute current left column width in pixels
        const left = document.getElementById('leftCol')
        const rect = left.getBoundingClientRect()
        return Math.round(rect.width)
      }

      function setLeftWidthPx(px) {
        document.documentElement.style.setProperty('--left-col', px + 'px')
      }

      function persistSplitWidth() {
        try {
          const s = JSON.parse(localStorage.getItem('selectTestSettings') || '{}')
          s.leftWidthPx = getLeftWidthPx()
          localStorage.setItem('selectTestSettings', JSON.stringify(s))
        } catch (_) {}
      }

      function restoreSplitWidth() {
        try {
          const s = JSON.parse(localStorage.getItem('selectTestSettings') || '{}')
          if (s.leftWidthPx) setLeftWidthPx(s.leftWidthPx)
        } catch (_) {}
      }
      load()
    </script>
  </body>
  </html>
